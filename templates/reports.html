<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOM Platform - Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    .section-header {
      background: linear-gradient(to right, #e5e7eb, #f3f4f6);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .btn-primary {
      background: linear-gradient(to right, #6366f1, #4f46e5);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background: linear-gradient(to right, #4f46e5, #4338ca);
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: linear-gradient(to right, #10b981, #059669);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      background: linear-gradient(to right, #059669, #047857);
      transform: translateY(-1px);
    }
    .stats-card {
      background: linear-gradient(to right, #f3f4f6, #e5e7eb);
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .table-container {
      overflow-x: auto;
      max-height: 500px;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    th {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    td, th {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .action-items {
      white-space: pre-wrap;
    }
    .nav-link {
      color: #4b5563;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }
    .nav-link:hover {
      background: #e5e7eb;
      color: #1f2937;
    }
    .nav-link.active {
      background: #6366f1;
      color: white;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8 fade-in">
      <div class="text-left">
        <h1 class="text-4xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-file-alt mr-3 text-indigo-600"></i>
          Reports
        </h1>
        <p class="text-gray-600 text-lg">View Reports & Action Items</p>
      </div>
      <div class="flex gap-4">
        <a href="/team_members" class="nav-link">Manage Team</a>
        <button onclick="logout()" 
                class="inline-flex items-center bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-lg transition duration-200">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
    </div>

    <!-- Stats Card -->
    <div class="mb-6 fade-in">
      <div class="stats-card flex items-center justify-between p-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-700">Reports for Selected Date</h3>
          <p id="totalReports" class="text-2xl font-bold text-indigo-600">0</p>
        </div>
        <i class="fas fa-file-alt text-3xl text-indigo-500"></i>
      </div>
    </div>

    <!-- Reports Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 glass-effect fade-in">
      <h2 class="text-xl font-bold mb-4 flex items-center section-header">
        <i class="fas fa-file-alt mr-2 text-orange-500"></i>View Reports
      </h2>
      <div class="flex gap-4 mb-4">
        <input type="date" id="reportDate" value="{{ today_date }}" class="p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-400 flex-1">
        <button onclick="loadReports()" class="btn-primary">
          <i class="fas fa-search mr-2"></i>Load Reports
        </button>
        <button onclick="viewTodayReport()" class="btn-secondary">
          <i class="fas fa-calendar-day mr-2"></i>Today's Report
        </button>
      </div>
      <div id="reportsLoading" class="hidden"><div class="loading-spinner"></div></div>
      <div class="table-container">
        <table id="reportsTable" class="hidden">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Name</th>
              <th>Yesterday</th>
              <th>Today</th>
              <th>Blockers</th>
            </tr>
          </thead>
          <tbody id="reportsBody"></tbody>
        </table>
      </div>
      <div class="flex justify-end gap-4 mt-6">
        <button id="generateActionBtn" onclick="generateActionItems()" class="btn-primary hidden">
          <i class="fas fa-magic mr-2"></i>Generate Action Items
        </button>
        <button id="downloadBtn" onclick="downloadReport()" class="btn-secondary hidden">
          <i class="fas fa-download mr-2"></i>Download Report
        </button>
      </div>
    </div>

    <!-- Action Items Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 glass-effect fade-in mt-6">
      <h2 class="text-xl font-bold mb-4 flex items-center section-header">
        <i class="fas fa-tasks mr-2 text-purple-500"></i>Action Items
      </h2>
      <div id="actionItemsLoading" class="hidden"><div class="loading-spinner"></div></div>
      <ul id="actionItemsList" class="list-disc pl-5 space-y-1"></ul>
    </div>
  </div>

  <script>
    // Set default date to today
    document.getElementById('reportDate').value = '{{ today_date }}';

    // Logout (clear cookie and redirect)
    function logout() {
      document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      window.location.href = '/login';
    }

    // Load Reports
    async function loadReports() {
      const date = document.getElementById('reportDate').value;
      if (!date) {
        alert('Please select a date');
        return;
      }
      const loading = document.getElementById('reportsLoading');
      loading.classList.remove('hidden');
      const table = document.getElementById('reportsTable');
      table.classList.add('hidden');
      try {
        const response = await fetch(`/reports/${date}`);
        const reports = await response.json();
        const tbody = document.getElementById('reportsBody');
        tbody.innerHTML = '';
        reports.forEach(report => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${report.sno}</td>
            <td>${report.name}</td>
            <td>${formatPoints(report.yesterday)}</td>
            <td>${formatPoints(report.today)}</td>
            <td>${formatPoints(report.blockers || 'None')}</td>
          `;
          tbody.appendChild(tr);
        });
        table.classList.remove('hidden');
        document.getElementById('generateActionBtn').classList.remove('hidden');
        document.getElementById('downloadBtn').classList.remove('hidden');
        document.getElementById('totalReports').textContent = reports.length;
        loadActionItems();
      } catch {
        alert('Error loading reports');
      } finally {
        loading.classList.add('hidden');
      }
    }

    // Format points as unordered list
    function formatPoints(text) {
      if (!text || text === 'None') return 'None';
      const points = text.split('\n').filter(p => p.trim());
      if (points.length === 0) return '';
      return `<ul class="list-disc pl-5 space-y-1">${points.map(p => `<li>${p.replace(/^â€¢\s*/, '')}</li>`).join('')}</ul>`;
    }

    // View Today's Report
    function viewTodayReport() {
      document.getElementById('reportDate').value = '{{ today_date }}';
      loadReports();
    }

    // Generate Action Items
    async function generateActionItems() {
      const date = document.getElementById('reportDate').value;
      const loading = document.getElementById('actionItemsLoading');
      loading.classList.remove('hidden');
      try {
        const response = await fetch(`/generate_action_items/${date}`);
        const data = await response.json();
        displayActionItems(data.action_items);
      } catch {
        alert('Error generating action items');
      } finally {
        loading.classList.add('hidden');
      }
    }

    // Load Action Items (if already generated)
    async function loadActionItems() {
      const date = document.getElementById('reportDate').value;
      try {
        const response = await fetch(`/action_items/${date}`);
        const data = await response.json();
        displayActionItems(data.action_items);
      } catch {
        document.getElementById('actionItemsList').innerHTML = '';
      }
    }

    // Display Action Items as list
    function displayActionItems(text) {
      const list = document.getElementById('actionItemsList');
      list.innerHTML = '';
      if (!text) {
        const li = document.createElement('li');
        li.textContent = 'No action items generated yet.';
        list.appendChild(li);
        return;
      }
      const points = text.split('\n').filter(p => p.trim());
      points.forEach(point => {
        const li = document.createElement('li');
        li.textContent = point.replace(/^â€¢\s*/, '');
        list.appendChild(li);
      });
    }

    // Download Report
    function downloadReport() {
      const date = document.getElementById('reportDate').value;
      window.location.href = `/download_report/${date}`;
    }

    // Initial load
    loadReports();
  </script>
</body>
</html>